# this is the snakemake pipeline for analysis the metagenomic data

configfile: "config/config.yml"

rule all:
    input:
        "results/dorado/summary.txt",
        "results/nanoplot/sequencing_summary.txt"


rule dorado_basecall:
    output:
        bam = "results/dorado/output.bam"
    threads: 4
    params:
        input_dir = config["raw_data_dir"],
        model = config["dorado_model"],
        dorado = config["dorado_path"]
    resources:
        mem_mb = 8000,
        partition = "gpu",
        slurm = "gpus=1"
    shell:
        """
        {params.dorado} basecaller -r {params.model} {params.input_dir} > {output.bam}
        """

rule dorado_summary:
    input:
        "results/dorado/output.bam"
    output:
        "results/dorado/summary.txt"
    params:
        dorado = config["dorado_path"]
    threads: 1
    resources:
        mem_mb = 8000
    shell:
        """
        {params.dorado} summary {input} > {output}
        """

rule sort_bam:
    input:
        "results/dorado/output.bam"
    output:
        "results/dorado/output.sorted.bam"
    conda:
        "envs/readtools.yml"
    threads: 16
    resources:
        mem_mb = 16000
    shell:
        """
        samtools sort -@ {threads} -o {output} {input}
        """

rule nanoplot:
    input:
        "results/dorado/output.sorted.bam"
    output:
        "results/nanoplot/sequencing_summary.txt"
    conda:
        "envs/readtools.yml"
    threads: 8
    resources:
        mem_mb = 16000
    shell:
        """
        NanoPlot -t {threads} --bam {input} --outdir results/nanoplot
        """
